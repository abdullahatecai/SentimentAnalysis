<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Review Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .hero {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .search-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 10px;
            z-index: 900;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
            z-index: 901;
        }

        #locationInput {
            width: 100%;
            padding: 15px 260px 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        #locationInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .autocomplete-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f8f9ff;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            margin: 20px 0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .location-info {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .location-photo {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .location-details {
            flex: 1;
            text-align: left;
        }

        .location-details h2 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 2rem;
        }

        .location-details p {
            margin: 5px 0;
            color: #666;
            font-size: 1.1rem;
        }

        .location-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .location-meta a,
        .location-meta span {
            color: #667eea;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
        }

        .location-meta a:hover {
            text-decoration: underline;
        }

        .rating-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .rating-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .rating-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .rating-card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .sentiment-analysis {
            margin-bottom: 30px;
        }

        .sentiment-bars {
            display: flex;
            gap: 2px;
            margin-top: 15px;
            width: 100%;
            overflow: hidden;
            border-radius: 15px;
            background: #e9ecef;
        }

        .sentiment-bar {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            font-size: 13px;
        }

        .positive { background: linear-gradient(135deg, #56ab2f, #a8e6cf); }
        .neutral { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); }
        .negative { background: linear-gradient(135deg, #ff7675, #d63031); }

        .reviews-list {
            margin-top: 20px;
        }

        .review-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .review-header {
            display: flex;
    justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .review-author {
            font-weight: bold;
            color: #333;
        }

        .review-rating {
            color: #ffd700;
        }

        .review-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .review-sentiment {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .sentiment-positive {
            background: #d4edda;
            color: #155724;
        }

        .sentiment-negative {
            background: #f8d7da;
            color: #721c24;
        }

        .sentiment-neutral {
            background: #fff3cd;
            color: #856404;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        /* AI Insights */
        .ai-insights { margin-top: 24px; }
        .ai-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
        .ai-card { background: #ffffff; border-radius: 14px; padding: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
        .ai-card h4 { margin-bottom: 10px; color: #333; }
        .ai-list { list-style: none; padding-left: 0; }
        .ai-list li { padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .ai-list li:last-child { border-bottom: 0; }

        /* Language switcher */
        .lang-switch {
            position: fixed;
            top: 12px;
            left: 12px;
            right: auto;
            display: flex;
            gap: 12px;
            z-index: 1001;
        }

        .lang-btn {
            border: 2px solid #cbd5e1;
            background: #ffffff;
            color: #1f2937;
            border-radius: 24px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            line-height: 1;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
        }

        .lang-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }

        .lang-btn:focus {
            outline: 3px solid rgba(102,126,234,0.35);
            outline-offset: 2px;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 6px 14px rgba(102,126,234,0.35);
        }

        /* Sentiment emoji */
        .sentiment-emoji {
            width: clamp(36px, 6vw, 64px);
            height: clamp(36px, 6vw, 64px);
            margin: 8px auto 0 auto;
            display: none;
        }

        /* Mobile fixes */
        @media (max-width: 768px) {
            .location-info {
                flex-direction: column;
                text-align: center;
            }
            
            .location-details {
                text-align: center;
            }
            
            .location-photo {
                width: 150px;
                height: 150px;
            }
            
            .location-meta {
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .container { padding: 12px; }
            .hero { margin-bottom: 16px; }
            .hero h1 { font-size: 1.6rem; }
            .hero p { font-size: 0.95rem; }

            .lang-switch {
                position: static;
                justify-content: center;
                margin-bottom: 10px;
            }

            .search-section {
                position: sticky;
                top: 6px;
                padding: 16px;
                z-index: 900;
            }

            .search-container { z-index: 901; }

            #locationInput {
                padding: 12px 120px 12px 14px; /* room for Analyze button */
                font-size: 16px;
            }

            .search-btn {
                right: 6px;
                padding: 6px 10px;
                font-size: 14px;
            }

            .autocomplete-dropdown { max-height: 240px; }

            /* Stack bars on mobile to avoid overlap */
            .sentiment-bars { flex-direction: column; border-radius: 10px; gap: 6px; background: transparent; }
            .sentiment-bar {
                width: 100% !important;
                border-left: 0;
                border-radius: 8px;
                font-size: 13px;
                padding: 8px 10px;
                white-space: normal; /* allow wrapping for long Arabic labels */
                overflow: visible;   /* avoid text being clipped */
                height: auto;
                min-height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-switch">
            <button id="btnLangEn" class="lang-btn active">EN</button>
            <button id="btnLangAr" class="lang-btn">ÿπÿ±ÿ®Ÿä</button>
        </div>
        <div class="hero">
            <h1>Location Review Analyzer</h1>
            <p>Discover what people really think about any location with AI-powered sentiment analysis</p>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" id="locationInput" placeholder="Search for a location (e.g., restaurants, hotels, attractions...)" />
                <button class="search-btn" onclick="searchLocation()">üîç <span id="analyzeText">Analyze</span></button>
                <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Analyzing location and processing reviews...</p>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="results" class="results" style="display: none;">
            <div class="location-info">
                <img id="locationPhoto" class="location-photo" style="display: none;" alt="Location" />
                <div class="location-details">
                    <h2 id="locationName"></h2>
                    <p id="locationAddress"></p>
                    <div class="location-meta">
                        <a id="locationWebsite" href="#" target="_blank" rel="noopener" style="display: none;">
                            üåê <span id="websiteLabel">Website</span>
                        </a>
                        <span id="locationPhone" style="display: none;">
                            üìû <span id="phoneNumber"></span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="rating-overview">
                <div class="rating-card">
                    <h3 id="overallRatingLabel">Overall Rating</h3>
                    <div class="value" id="overallRating">-</div>
                </div>
                <div class="rating-card">
                    <h3 id="totalReviewsLabel">Total Reviews</h3>
                    <div class="value" id="totalReviews">-</div>
                </div>
                <div class="rating-card">
                    <h3 id="sentimentScoreLabel">Sentiment Score</h3>
                    <div class="value" id="sentimentScore">-</div>
                    <img id="sentimentEmoji" class="sentiment-emoji" alt="sentiment" />
                </div>
            </div>

            <div class="sentiment-analysis">
                <h3 id="sentimentAnalysisLabel">Sentiment Analysis</h3>
                <div class="sentiment-bars">
                    <div class="sentiment-bar positive" id="positiveBar">Positive: 0%</div>
                    <div class="sentiment-bar neutral" id="neutralBar">Neutral: 0%</div>
                    <div class="sentiment-bar negative" id="negativeBar">Negative: 0%</div>
                </div>
            </div>

            <div class="ai-insights" id="aiInsights" style="display: none;">
                <h3 id="aiInsightsLabel">AI Insights</h3>
                <div class="ai-grid">
                    <div class="ai-card">
                        <h4 id="topTopicsLabel">Top Topics</h4>
                        <h5 id="topTopicsPosLabel">Positive</h5>
                        <ul class="ai-list" id="topTopicsPos"></ul>
                        <h5 id="topTopicsNegLabel">Negative</h5>
                        <ul class="ai-list" id="topTopicsNeg"></ul>
                        <h5 id="topTopicsNeuLabel">Neutral</h5>
                        <ul class="ai-list" id="topTopicsNeu"></ul>
                    </div>
                    <div class="ai-card">
                        <h4 id="topEmployeesLabel">Top Employees</h4>
                        <h5 id="topEmployeesPosLabel">Positive</h5>
                        <ul class="ai-list" id="topEmployeesPos"></ul>
                        <h5 id="topEmployeesNegLabel">Negative</h5>
                        <ul class="ai-list" id="topEmployeesNeg"></ul>
                        <h5 id="topEmployeesNeuLabel">Neutral</h5>
                        <ul class="ai-list" id="topEmployeesNeu"></ul>
                    </div>
                    <div class="ai-card">
                        <h4 id="aiSentimentDistLabel">AI Sentiment Distribution</h4>
                        <ul class="ai-list" id="aiSentimentDistList"></ul>
                    </div>
                </div>
            </div>

            <div class="reviews-list">
                <h3 id="recentReviewsLabel">Recent Reviews</h3>
                <div id="reviewsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - ngrok tunnel to local n8n
        const N8N_WEBHOOK_URL = 'https://n884670.app.n8n.cloud/webhook-test/analyze-reviews-sentiments';

        let autocompleteService;
        let placesService;
        let selectedPlace = null;
        let isGoogleMapsLoaded = false;

        // I18N
        const i18n = {
            en: {
                appTitle: 'Location Review Analyzer',
                tagline: 'Discover what people really think about any location with AI-powered sentiment analysis',
                searchPlaceholder: 'Search for a location (e.g., restaurants, hotels, attractions...)',
                analyze: 'Analyze',
                overallRating: 'Overall Rating',
                totalReviews: 'Total Reviews',
                sentimentScore: 'Sentiment Score',
                sentimentAnalysis: 'Sentiment Analysis',
                recentReviews: 'Recent Reviews',
                positive: 'Positive',
                neutral: 'Neutral',
                negative: 'Negative',
                positiveSentiment: 'Positive Sentiment',
                neutralSentiment: 'Neutral Sentiment',
                negativeSentiment: 'Negative Sentiment',
                noReviewText: 'No review text available.',
                notAnalyzed: 'Not analyzed',
                analyzing: 'Analyzing location and processing reviews...',
                enterLocation: 'Please enter a location to search',
                mapsNotLoaded: 'Google Maps is not loaded. Please refresh the page and try again.',
                locationNotFound: 'Location not found. Please try a different search term.',
                analyzeFailed: 'Failed to analyze location. Please check your n8n workflow and try again.'
            },
            ar: {
                appTitle: 'ŸÖÿ≠ŸÑŸÑ ÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑŸÖŸàÿßŸÇÿπ',
                tagline: 'ÿßŸÉÿ™ÿ¥ŸÅ ÿ¢ÿ±ÿßÿ° ÿßŸÑŸÜÿßÿ≥ ÿ≠ŸàŸÑ ÿ£Ÿä ŸÖŸàŸÇÿπ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿπÿ± ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä',
                searchPlaceholder: 'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸàŸÇÿπ (ŸÖÿ´ŸÑ ÿßŸÑŸÖÿ∑ÿßÿπŸÖÿå ÿßŸÑŸÅŸÜÿßÿØŸÇÿå ÿßŸÑŸÖÿπÿßŸÑŸÖ...)',
                analyze: 'ÿ™ÿ≠ŸÑŸäŸÑ',
                overallRating: 'ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿπÿßŸÖ',
                totalReviews: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™',
                sentimentScore: 'ÿØÿ±ÿ¨ÿ© ÿßŸÑŸÖÿ¥ÿßÿπÿ±',
                sentimentAnalysis: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿπÿ±',
                recentReviews: 'ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™',
                positive: 'ÿ•Ÿäÿ¨ÿßÿ®Ÿä',
                neutral: 'ŸÖÿ≠ÿßŸäÿØ',
                negative: 'ÿ≥ŸÑÿ®Ÿä',
                positiveSentiment: 'ŸÖÿ¥ÿßÿπÿ± ÿ•Ÿäÿ¨ÿßÿ®Ÿäÿ©',
                neutralSentiment: 'ŸÖÿ¥ÿßÿπÿ± ŸÖÿ≠ÿßŸäÿØÿ©',
                negativeSentiment: 'ŸÖÿ¥ÿßÿπÿ± ÿ≥ŸÑÿ®Ÿäÿ©',
                noReviewText: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿµ ŸÖÿ±ÿßÿ¨ÿπÿ©.',
                notAnalyzed: 'ÿ∫Ÿäÿ± ŸÖŸèÿ≠ŸÑŸëŸéŸÑ',
                analyzing: 'ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàŸÇÿπ ŸàŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™...',
                enterLocation: 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖŸàŸÇÿπ ŸÑŸÑÿ®ÿ≠ÿ´',
                mapsNotLoaded: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.',
                locationNotFound: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ¨ÿ±ÿ®ÿ© ŸÖÿµÿ∑ŸÑÿ≠ ÿ®ÿ≠ÿ´ ŸÖÿÆÿ™ŸÑŸÅ.',
                analyzeFailed: 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàŸÇÿπ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≥Ÿäÿ± ÿπŸÖŸÑ n8n ÿ´ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
            }
        };

        let currentLang = 'en';
        function t(key){
            return (i18n[currentLang] && i18n[currentLang][key]) || key;
        }

        function applyTranslations(){
            document.querySelector('.hero h1').textContent = t('appTitle');
            document.querySelector('.hero p').textContent = t('tagline');
            document.getElementById('locationInput').placeholder = t('searchPlaceholder');
            document.getElementById('analyzeText').textContent = t('analyze');
            document.getElementById('overallRatingLabel').textContent = t('overallRating');
            document.getElementById('totalReviewsLabel').textContent = t('totalReviews');
            document.getElementById('sentimentScoreLabel').textContent = t('sentimentScore');
            document.getElementById('sentimentAnalysisLabel').textContent = t('sentimentAnalysis');
            document.getElementById('recentReviewsLabel').textContent = t('recentReviews');
            document.getElementById('positiveBar').textContent = `${t('positive')}: 0%`;
            document.getElementById('neutralBar').textContent = `${t('neutral')}: 0%`;
            document.getElementById('negativeBar').textContent = `${t('negative')}: 0%`;
            const aiEl = document.getElementById('aiInsightsLabel'); if (aiEl) aiEl.textContent = (i18n[currentLang].aiInsights || 'AI Insights');
            const tt = document.getElementById('topTopicsLabel'); if (tt) tt.textContent = (i18n[currentLang].topTopics || 'Top Topics');
            const te = document.getElementById('topEmployeesLabel'); if (te) te.textContent = (i18n[currentLang].topEmployees || 'Top Employees');
            const asd = document.getElementById('aiSentimentDistLabel'); if (asd) asd.textContent = (i18n[currentLang].aiSentimentDist || 'AI Sentiment Distribution');
        }

        function setLanguage(lang){
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('btnLangEn').classList.toggle('active', lang === 'en');
            document.getElementById('btnLangAr').classList.toggle('active', lang === 'ar');
            applyTranslations();
        }

        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('btnLangEn').addEventListener('click', function(){ setLanguage('en'); });
            document.getElementById('btnLangAr').addEventListener('click', function(){ setLanguage('ar'); });
            setLanguage('en');
        });

        // Initialize Google Maps services
        // Google Maps JS no longer required; using server-side endpoints instead
        function initMap() {}
        function ensureGoogleMapsLoaded() {}

        // Handle location input changes for autocomplete (server-side)
        document.getElementById('locationInput').addEventListener('input', async function(e) {
            const query = e.target.value.trim();
            if (query.length <= 2) {
                hideAutocomplete();
                return;
            }
            try {
                const res = await fetch('https://n884670.app.n8n.cloud/webhook-test/places-autocomplete-sentiments', {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });
                if (!res.ok) {
                    console.error('Autocomplete request failed:', res.status, res.statusText);
                    return hideAutocomplete();
                }
                const data = await res.json();
                const predictions = data.predictions || [];
                showAutocompleteSuggestions(predictions.map(p => ({ description: p.description, place_id: p.place_id })));
            } catch (error) {
                console.error('Autocomplete error:', error);
                hideAutocomplete();
            }
        });

        // Get autocomplete predictions
        // removed client-side autocomplete (now server-side)

        // Show autocomplete suggestions
        function showAutocompleteSuggestions(predictions) {
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.innerHTML = '';
            
            predictions.slice(0, 5).forEach(prediction => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = prediction.description;
                item.onclick = () => selectPlace(prediction);
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        // Hide autocomplete dropdown
        function hideAutocomplete() {
            document.getElementById('autocompleteDropdown').style.display = 'none';
        }

        // Select a place from autocomplete
        function selectPlace(prediction) {
            document.getElementById('locationInput').value = prediction.description;
            selectedPlace = prediction;
            hideAutocomplete();
        }

        // Search for location and analyze reviews
        function searchLocation() {
            const query = document.getElementById('locationInput').value.trim();
            
            if (!query) {
                showError(t('enterLocation'));
                return;
            }

            // No client-side Maps dependency; proceed directly

            if (selectedPlace) {
                analyzeLocation(selectedPlace.place_id);
            } else {
                // If no place selected from autocomplete, search by text
                findPlaceByText(query);
            }
        }

        // Find place by text search
        async function findPlaceByText(query) {
            try {
                const res = await fetch('https://n884670.app.n8n.cloud/webhook-test/place-search-sentiments', {
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });
                if (!res.ok) {
                    console.error('Place search failed:', res.status, res.statusText);
                    return showError(t('locationNotFound'));
                }
                const data = await res.json();
                const first = (data.results || [])[0];
                if (first && first.place_id) return analyzeLocation(first.place_id);
                showError(t('locationNotFound'));
            } catch (error) {
                console.error('Place search error:', error);
                showError(t('locationNotFound'));
            }
        }

        // Analyze location using n8n webhook
        async function analyzeLocation(placeId) {
            showLoading();
            hideError();
            hideResults();

            try {
                let response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        place_id: placeId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const payload = Array.isArray(data) ? (data[0] || {}) : data;
                displayResults(payload);
            } catch (error) {
                console.error('Error analyzing location:', error);
                showError(t('analyzeFailed'));
            } finally {
                hideLoading();
            }
        }

        // Display analysis results
        function displayResults(data) {
            const placeName = data.place_name || data._place_name || 'Unknown Location';
            const address = data.address || '';
            const rating = typeof data.rating === 'number' ? data.rating : null;
            const totalReviews = data.total_reviews || data.total_processed_reviews || 0;
            const sentimentScore = typeof data.sentiment_score === 'number' ? data.sentiment_score : (typeof data.overall_sentiment_score === 'number' ? data.overall_sentiment_score : null);

            document.getElementById('locationName').textContent = placeName;
            document.getElementById('locationAddress').textContent = address;
            
            // Display location photo
            const photoEl = document.getElementById('locationPhoto');
            if (data.photo_reference) {
                // Use Google Places Photo API proxy through n8n to hide API key
                const photoProxyUrl = `${N8N_WEBHOOK_URL.replace('analyze-reviews-sentiments', 'place-photo')}?photo_reference=${data.photo_reference}&maxwidth=800`;
                photoEl.src = photoProxyUrl;
                photoEl.style.display = 'block';
                photoEl.onerror = function() {
                    this.style.display = 'none'; // Hide if photo fails to load
                };
            } else {
                photoEl.style.display = 'none';
            }
            
            // Display website
            const websiteEl = document.getElementById('locationWebsite');
            if (data.website) {
                websiteEl.href = data.website;
                websiteEl.style.display = 'inline-flex';
            } else {
                websiteEl.style.display = 'none';
            }
            
            // Display phone
            const phoneEl = document.getElementById('locationPhone');
            const phoneNumEl = document.getElementById('phoneNumber');
            if (data.phone) {
                phoneNumEl.textContent = data.phone;
                phoneEl.style.display = 'inline-flex';
            } else {
                phoneEl.style.display = 'none';
            }
            document.getElementById('overallRating').textContent = rating !== null ? rating.toFixed(1) : 'N/A';
            document.getElementById('totalReviews').textContent = totalReviews;
            document.getElementById('sentimentScore').textContent = sentimentScore !== null ? sentimentScore.toFixed(1) : 'N/A';
            // Emoji selection
            const emojiEl = document.getElementById('sentimentEmoji');
            if (sentimentScore !== null) {
                let emojiPath = '';
                if (sentimentScore < 5) {
                    emojiPath = './bad.png';
                } else if (sentimentScore <= 7) {
                    emojiPath = './neutral.png';
                } else {
                    emojiPath = './happy.png';
                }
                emojiEl.src = emojiPath;
                emojiEl.alt = sentimentScore < 5 ? 'bad' : (sentimentScore <= 7 ? 'neutral' : 'happy');
                emojiEl.style.display = 'block';
            } else {
                emojiEl.style.display = 'none';
            }

            // Update sentiment bars
            const sentiment = data.sentiment_analysis || { positive: 0, neutral: 0, negative: 0 };
            const total = sentiment.positive + sentiment.neutral + sentiment.negative;
            
            if (total > 0) {
                const posPercent = Math.round((sentiment.positive / total) * 100);
                const neutPercent = Math.round((sentiment.neutral / total) * 100);
                const negPercent = Math.round((sentiment.negative / total) * 100);

                const posEl = document.getElementById('positiveBar');
                const neutEl = document.getElementById('neutralBar');
                const negEl = document.getElementById('negativeBar');

                // Helper to keep labels readable on very small segments
                function setBar(el, label, percent) {
                    let text = `${label}: ${percent}%`;
                    if (percent <= 10) {
                        el.style.fontSize = '11px';
                        text = `${label.charAt(0)}: ${percent}%`;
                    } else if (percent <= 18) {
                        el.style.fontSize = '12px';
                    } else {
                        el.style.fontSize = '13px';
                    }
                    el.textContent = text;
                }

                setBar(posEl, t('positive'), posPercent);
                setBar(neutEl, t('neutral'), neutPercent);
                setBar(negEl, t('negative'), negPercent);

                // Optionally set CSS grid columns for compatibility (no effect with flex)
                const cols = `${Math.max(posPercent, 1)}fr ${Math.max(neutPercent, 1)}fr ${Math.max(negPercent, 1)}fr`;
                document.querySelector('.sentiment-bars').style.gridTemplateColumns = cols;

                // Set bar widths for desktop, stack full width on mobile
                function applyBarWidths() {
                    if (window.innerWidth > 576) {
                        posEl.style.width = `${Math.max(posPercent, 2)}%`;
                        neutEl.style.width = `${Math.max(neutPercent, 2)}%`;
                        negEl.style.width = `${Math.max(negPercent, 2)}%`;
                        document.querySelector('.sentiment-bars').style.flexDirection = 'row';
                    } else {
                        document.querySelector('.sentiment-bars').style.flexDirection = 'column';
                        [posEl, neutEl, negEl].forEach(el => { el.style.width = '100%'; });
                    }
                }
                applyBarWidths();

                if (!window.__sentimentResizeAttached) {
                    window.addEventListener('resize', applyBarWidths);
                    window.__sentimentResizeAttached = true;
                }
            }

            // AI Insights rendering
            renderAiInsights(data.ai_summary);

            // Display reviews
            const reviews = data.reviews || data.all_reviews || data.analyzed_reviews || [];
            displayReviews(reviews);
            showResults();
        }

        function renderAiInsights(ai) {
            const wrap = document.getElementById('aiInsights');
            if (!wrap) return;
            if (!ai) { wrap.style.display = 'none'; return; }
            const topicsPos = document.getElementById('topTopicsPos');
            const topicsNeg = document.getElementById('topTopicsNeg');
            const topicsNeu = document.getElementById('topTopicsNeu');
            const empPos = document.getElementById('topEmployeesPos');
            const empNeg = document.getElementById('topEmployeesNeg');
            const empNeu = document.getElementById('topEmployeesNeu');
            const distEl = document.getElementById('aiSentimentDistList');
            [topicsPos, topicsNeg, topicsNeu, empPos, empNeg, empNeu].forEach(el => { if (el) el.innerHTML = ''; });
            distEl.innerHTML = '';

            // Prefer grouped summary; fallback to flat
            const grouped = ai.ai_summary_grouped || ai;
            const topicsGrouped = grouped.topics || {};
            const employeesGrouped = grouped.employees || {};
            const renderList = (ul, arr, isEmp=false) => {
                if (!ul) return;
                (arr || []).slice(0, 10).forEach(it => {
                    const li = document.createElement('li');
                    li.textContent = isEmp
                        ? (it.sample_comment ? `${it.name} ‚Äî ${it.count} (${it.sample_comment})` : `${it.name} ‚Äî ${it.count}`)
                        : `${it.topic} ‚Äî ${it.count}`;
                    ul.appendChild(li);
                });
            };
            renderList(topicsPos, (topicsGrouped.positive || grouped.topics?.positive || []));
            renderList(topicsNeg, (topicsGrouped.negative || grouped.topics?.negative || []));
            renderList(topicsNeu, (topicsGrouped.neutral  || grouped.topics?.neutral  || []));

            renderList(empPos, (employeesGrouped.positive || grouped.employees?.positive || []), true);
            renderList(empNeg, (employeesGrouped.negative || grouped.employees?.negative || []), true);
            renderList(empNeu, (employeesGrouped.neutral  || grouped.employees?.neutral  || []), true);

            const dist = ai.sentiments_count || grouped.sentiments_count || {};
            Object.keys(dist).forEach(k => {
                const li = document.createElement('li');
                li.textContent = `${k}: ${dist[k]}`;
                distEl.appendChild(li);
            });

            const hasData = (topicsGrouped.positive?.length || topicsGrouped.negative?.length || topicsGrouped.neutral?.length || employeesGrouped.positive?.length || employeesGrouped.negative?.length || employeesGrouped.neutral?.length || Object.keys(dist).length);
            wrap.style.display = hasData ? 'block' : 'none';
        }

        // Display individual reviews
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '';

            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p>No reviews available for analysis.</p>';
                return;
            }

            reviews.forEach(review => {
                const reviewElement = document.createElement('div');
                reviewElement.className = 'review-item';
                
                const stars = '‚òÖ'.repeat(review.rating || 0) + '‚òÜ'.repeat(5 - (review.rating || 0));
                const isNotAnalyzed = review.has_sentiment_analysis === false ||
                    (typeof review.sentiment === 'string' && review.sentiment.toLowerCase().includes('not analyzed'));
                const sentimentKey = isNotAnalyzed ? 'notAnalyzed' : ((review.sentiment || 'Neutral').toLowerCase() + 'Sentiment');
                const baseSentiment = (review.sentiment || 'neutral').toLowerCase();
                const sentimentClass = isNotAnalyzed ? 'sentiment-neutral' : `sentiment-${baseSentiment}`;
                const safeText = (review.text && review.text.trim()) ? review.text : t('noReviewText');
                
                reviewElement.innerHTML = `
                    <div class="review-header">
                        <span class="review-author">${review.author_name || 'Anonymous'}</span>
                        <span class="review-rating">${stars}</span>
                    </div>
                    <div class="review-text">${safeText}</div>
                    <span class="review-sentiment ${sentimentClass}">
                        ${t(sentimentKey)}
                    </span>
                `;
                
                reviewsList.appendChild(reviewElement);
            });
        }

        // UI helper functions
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showResults() {
            document.getElementById('results').style.display = 'block';
        }

        function hideResults() {
            document.getElementById('results').style.display = 'none';
        }

        // Handle Enter key in search input
        document.getElementById('locationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                hideAutocomplete();
            }
        });
    </script>
    
    <!-- Google Maps JS removed: using secure server-side endpoints in n8n -->
</body>
</html>